<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Bot Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ Dashboard do Bot</h1>
            <div>
                <span id="status-indicator">üîÑ Carregando...</span>
                <a href="/logout">Sair</a>
            </div>
        </header>

        <div class="main-content">
            <div class="config-panel">
                <h2>‚öôÔ∏è Configura√ß√µes</h2>
                
                <label>Usu√°rio FT:</label>
                <input type="text" id="ft_username" value="{{ config.FT_USERNAME or '' }}">
                
                <label>Senha FT:</label>
                <input type="password" id="ft_password" placeholder="Deixe em branco para n√£o alterar">
                
                <label>Jogo Slug:</label>
                <input type="text" id="jogo_slug" value="{{ config.JOGO_SLUG or '' }}">
                
                <label>Setor Alvo:</label>
                <input type="text" id="target_sector_slug" value="{{ config.TARGET_SECTOR_SLUG or '' }}">
                
                <!-- REMOVIDO: Campo DEPENDENTE_ID - agora √© extra√≠do automaticamente -->
                
                <label>OpenAI API Key:</label>
                <input type="password" id="openai_api_key" placeholder="Deixe em branco para n√£o alterar">
                
                <label>2Captcha API Key:</label>
                <input type="password" id="twocaptcha_api_key" placeholder="Deixe em branco para n√£o alterar">
                
                <button onclick="saveConfig()">üíæ Salvar</button>

                <div class="info-panel">
                    <h3>‚ÑπÔ∏è Status</h3>
                    <p><strong>Bot:</strong> <span id="bot-status">{{ status }}</span></p>
                    <p><strong>Jogo:</strong> {{ config.JOGO_SLUG or 'N√£o configurado' }}</p>
                    <p><strong>Setor:</strong> {{ config.TARGET_SECTOR_SLUG or 'N√£o configurado' }}</p>
                    <p><strong>Dependentes:</strong> <span style="color: #28a745;">Extra√ß√£o Autom√°tica</span></p>
                </div>
                
                <div class="info-panel" style="border-left-color: #17a2b8;">
                    <h3>üí° Nova Funcionalidade</h3>
                    <p><strong>IDs de Dependentes:</strong></p>
                    <p style="font-size: 13px; color: #6c757d;">
                        Agora s√£o extra√≠dos automaticamente da p√°gina do setor! 
                        N√£o √© mais necess√°rio configurar manualmente.
                    </p>
                    <p style="font-size: 12px; color: #495057;">
                        ‚úÖ O bot detecta todos os dependentes dispon√≠veis<br>
                        ‚úÖ Seleciona automaticamente o melhor para usar<br>
                        ‚úÖ Mostra nos logs qual dependente foi escolhido
                    </p>
                </div>
            </div>

            <div class="control-panel">
                <h2>üéÆ Controle</h2>
                
                <div class="control-buttons">
                    <button onclick="startBot()" class="btn-start">‚ñ∂Ô∏è Iniciar Bot</button>
                    <button onclick="stopBot()" class="btn-stop">‚èπÔ∏è Parar Bot</button>
                    <button onclick="restartBot()" class="btn-restart">üîÑ Reiniciar Bot</button>
                    <button onclick="clearLogs()" class="btn-clear">üßπ Limpar Logs</button>
                    <button onclick="downloadLogs()" class="btn-download">üì• Baixar Logs</button>
                    <button onclick="window.location.reload()" class="btn-refresh">‚Üª Atualizar</button>
                </div>

                <h3>üìú Logs do Bot</h3>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                    Logs persistentes ‚Ä¢ Atualiza√ß√£o autom√°tica ‚Ä¢ <span id="log-info">Carregando...</span>
                </div>
                
                <pre id="log-output">Carregando logs...</pre>
            </div>
        </div>
    </div>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <!-- App Script -->
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    
    <!-- Fallback direto caso app.js n√£o carregue -->
    <script>
        // Fallback de emerg√™ncia caso app.js n√£o carregue
        setTimeout(function() {
            const logOutput = document.getElementById('log-output');
            const logInfo = document.getElementById('log-info');
            const statusIndicator = document.getElementById('status-indicator');
            
            if (logOutput && logOutput.textContent === 'Carregando logs...') {
                console.log('üö® Fallback ativado - app.js n√£o carregou');
                statusIndicator.textContent = 'üî¥ Modo degradado';
                
                // Fun√ß√£o simples para carregar logs
                function loadLogs() {
                    fetch('/api/logs')
                        .then(res => res.json())
                        .then(data => {
                            logOutput.textContent = data.logs || 'Nenhum log dispon√≠vel';
                            logInfo.textContent = `${data.file_size} chars ‚Ä¢ ${new Date().toLocaleTimeString()}`;
                        })
                        .catch(err => {
                            logOutput.textContent = 'Erro ao carregar logs: ' + err.message;
                            logInfo.textContent = 'Erro';
                        });
                }
                
                // Carrega logs e recarrega a cada 5 segundos
                loadLogs();
                setInterval(loadLogs, 5000);
                
                // Fun√ß√µes b√°sicas dos bot√µes
                window.startBot = function() {
                    fetch('/start_bot', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message);
                            document.getElementById('bot-status').textContent = 'Rodando';
                            loadLogs();
                        });
                };
                
                window.stopBot = function() {
                    fetch('/stop_bot', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message);
                            document.getElementById('bot-status').textContent = 'Parado';
                            loadLogs();
                        });
                };
                
                window.restartBot = function() {
                    if (confirm('Tem certeza que deseja reiniciar o bot? Os logs ser√£o limpos.')) {
                        fetch('/restart_bot', { method: 'POST' })
                            .then(res => res.json())
                            .then(data => {
                                alert(data.message);
                                document.getElementById('bot-status').textContent = 'Rodando';
                                loadLogs();
                            })
                            .catch(err => alert('Erro: ' + err.message));
                    }
                };
                
                window.clearLogs = function() {
                    if (confirm('Tem certeza que deseja limpar todos os logs?')) {
                        fetch('/clear_logs', { method: 'POST' })
                            .then(res => res.json())
                            .then(data => {
                                alert(data.message);
                                loadLogs();
                            })
                            .catch(err => alert('Erro: ' + err.message));
                    }
                };
                
                window.saveConfig = function() {
                    const data = {
                        FT_USERNAME: document.getElementById('ft_username').value,
                        FT_PASSWORD: document.getElementById('ft_password').value,
                        JOGO_SLUG: document.getElementById('jogo_slug').value,
                        TARGET_SECTOR_SLUG: document.getElementById('target_sector_slug').value,
                        // REMOVIDO: DEPENDENTE_ID
                        OPENAI_API_KEY: document.getElementById('openai_api_key').value,
                        TWOCAPTCHA_API_KEY: document.getElementById('twocaptcha_api_key').value
                    };
                    
                    Object.keys(data).forEach(key => {
                        if (data[key] === "") delete data[key];
                    });
                    
                    fetch('/save_config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    })
                    .then(res => res.json())
                    .then(data => {
                        alert(data.message);
                        window.location.reload();
                    });
                };
                
                window.downloadLogs = function() {
                    const logs = logOutput.textContent;
                    const blob = new Blob([logs], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'bot_logs.txt';
                    a.click();
                    URL.revokeObjectURL(url);
                };
            } else {
                statusIndicator.textContent = 'üü¢ Normal';
            }
        }, 3000); // Espera 3 segundos para ver se app.js carregou
    </script>
</body>
</html>
