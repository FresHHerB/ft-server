<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Bot Dashboard - Log Persistente</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ Dashboard do Bot de Reserva</h1>
            <div>
                <span id="connection-status">üîå Conectando...</span>
                <a href="/logout">Sair</a>
            </div>
        </header>

        <div class="main-content">
            <div class="config-panel">
                <h2>‚öôÔ∏è Configura√ß√µes</h2>
                <form id="configForm">
                    <label>Usu√°rio FT:</label>
                    <input type="text" id="ft_username" value="{{ config.FT_USERNAME or '' }}">
                    
                    <label>Senha FT:</label>
                    <input type="password" id="ft_password" placeholder="Deixe em branco para n√£o alterar">
                    
                    <label>Jogo Slug:</label>
                    <input type="text" id="jogo_slug" value="{{ config.JOGO_SLUG or '' }}">
                    
                    <label>Setor Alvo:</label>
                    <input type="text" id="target_sector_slug" value="{{ config.TARGET_SECTOR_SLUG or '' }}">
                    
                    <label>ID Dependente:</label>
                    <input type="text" id="dependente_id" value="{{ config.DEPENDENTE_ID or '' }}">
                    
                    <label>OpenAI API Key:</label>
                    <input type="password" id="openai_api_key" placeholder="Deixe em branco para n√£o alterar">
                    
                    <label>2Captcha API Key:</label>
                    <input type="password" id="twocaptcha_api_key" placeholder="Deixe em branco para n√£o alterar">
                    
                    <button type="button" onclick="saveConfig()">üíæ Salvar Configura√ß√µes</button>
                </form>

                <hr style="margin: 20px 0;">

                <h3>‚ÑπÔ∏è Informa√ß√µes</h3>
                <div class="info-panel">
                    <p><strong>Status do Bot:</strong> <span id="bot-status">{{ status }}</span></p>
                    <p><strong>Jogo:</strong> {{ config.JOGO_SLUG or 'N√£o configurado' }}</p>
                    <p><strong>Setor Alvo:</strong> {{ config.TARGET_SECTOR_SLUG or 'N√£o configurado' }}</p>
                    <p><strong>Max Tentativas:</strong> {{ config.MAX_WATCH_ATTEMPTS or '1800' }}</p>
                </div>
            </div>

            <div class="control-panel">
                <h2>üéÆ Controle e Monitoramento</h2>
                
                <div class="control-buttons">
                    <button onclick="startBot()" class="btn-start">‚ñ∂Ô∏è Iniciar Bot</button>
                    <button onclick="stopBot()" class="btn-stop">‚èπÔ∏è Parar Bot</button>
                    <button onclick="downloadLogs()" class="btn-download">üì• Baixar Logs</button>
                    <button onclick="window.location.reload()" class="btn-refresh">üîÑ Atualizar</button>
                </div>

                <h3>üìú Logs em Tempo Real (Persistente)</h3>
                <div class="log-info">
                    <small>
                        ‚úÖ Logs persistem entre sess√µes, dispositivos e atualiza√ß√µes<br>
                        üîÑ Atualiza√ß√µes autom√°ticas em tempo real<br>
                        üì± Sincronizado em todos os dispositivos
                    </small>
                </div>
                
                <pre id="log-output" class="log-output">Carregando logs...</pre>
                
                <div class="log-controls">
                    <small>
                        <span id="log-stats">Aguardando conex√£o...</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    
    <script>
        // Atualiza status de conex√£o
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('connection-status');
            const logStatsElement = document.getElementById('log-stats');
            const logOutput = document.getElementById('log-output');
            
            // Monitor de conex√£o WebSocket
            if (typeof io !== 'undefined') {
                const socket = io();
                
                socket.on('connect', () => {
                    statusElement.textContent = 'üü¢ Conectado';
                    statusElement.style.color = 'green';
                });
                
                socket.on('disconnect', () => {
                    statusElement.textContent = 'üî¥ Desconectado';
                    statusElement.style.color = 'red';
                });
                
                socket.on('historical_logs', (data) => {
                    const lineCount = data.logs.split('\n').length;
                    logStatsElement.textContent = `üìä ${lineCount} linhas | ${data.logs.length} chars`;
                });
                
                socket.on('new_log_line', () => {
                    const lineCount = logOutput.textContent.split('\n').length;
                    const charCount = logOutput.textContent.length;
                    logStatsElement.textContent = `üìä ${lineCount} linhas | ${charCount} chars | üî¥ AO VIVO`;
                });
            }
            
            // Auto-refresh status a cada minuto
            setInterval(() => {
                fetch('/api/logs')
                    .then(response => response.json())
                    .then(data => {
                        if (data.logs) {
                            const lineCount = data.logs.split('\n').length;
                            logStatsElement.textContent = `üìä ${lineCount} linhas | ${data.file_size} chars | ‚è∞ ${new Date().toLocaleTimeString()}`;
                        }
                    })
                    .catch(() => {
                        logStatsElement.textContent = '‚ùå Erro ao atualizar estat√≠sticas';
                    });
            }, 60000);
        });
    </script>
</body>
</html>
